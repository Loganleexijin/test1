断食APP需求文档
产品名称：Flux (灵动断食)

版本：MVP v1.0

核心理念：顺应身体节律，无压力的断食体验。

开发分工：

- **AI**：UI 构建、业务逻辑、API 对接、本地数据存储。
- **人工 (User)**：App Store 上架、证书配置、推送通知 (Push Notification) 权限申请。

---

## 0. 🔑 核心概念与数据口径（MVP 必须先统一）

### 0.1 记录的最小单位：Fasting Session

一次断食记录称为一个 `session`，用于历史列表、统计趋势、风控与通知。

**session 字段（MVP）**

- `id`
- `fasting_status`：`idle | fasting | eating | paused | completed`
- `start_at`：开始时间（实际发生）
- `end_at`：结束时间（实际发生；未结束可为空）
- `target_duration_hours`：目标断食时长（如 16）
- `duration_minutes`：实际断食时长（由 `now - start_at` 或 `end_at - start_at` 计算，不依赖计时器）
- `completed`：是否达成目标（`duration >= target_duration`）
- `source`：`manual_start | manual_edit | backfill | auto_recover`
- `timezone`：记录当时的时区（用于跨时区/系统时间变更的恢复）

### 0.2 统计口径（MVP 版本固定）

- “完成一次断食”：`completed=true`。
- “历史记录”：按 session 展示。
- “周/月趋势”：仍基于 session（不要另起口径）。

---

## 1. 💰 商业化与收费机制

采用 **Freemium (免费+订阅)** 模式。核心工具免费，AI 智能服务付费。

### 1.1 收费节点

- **免费用户**：
    - 使用“弹性时钟”的所有基础功能（开始/结束/调整时间）。
    - 查看基础历史记录（最近 7 次）。
- 接收本地基础提醒（若用户授予通知权限）。
- **Pro 会员**：
    - **AI 餐盘分析**：拍照识别食物热量与升糖建议。
    - **深度数据回顾**：查看周/月趋势图表。

### 1.2 定价策略

- **月卡**：$4.99 / 月
- **年卡**：$29.99 / 年（主推，显示 "Save 50%"）
- **终身买断**：$69.99（适合回笼资金）

### 1.3 支付逻辑

- 使用 RevenueCat SDK（适合 React Native 的内购集成工具）。
- *注：MVP 阶段若嫌麻烦，可先写死界面逻辑（模拟已付费），上架前再由人工接入 RevenueCat。*

### 1.4 Pro 降级/到期规则（MVP 必须写清楚）

- Pro 到期后：
    - 保留历史数据（包括历史 AI 结果，如已生成）。
    - 不可新增 AI 分析。
    - 深度趋势图表不可查看或只读（按实现成本二选一，但需明确）。

---

## 2. 🎨 UI/UX 设计规范

- **视觉风格**：Organic (有机), Ethereal (空灵)。
- **核心元素**：
    - **呼吸光晕 (Breathing Glow)**：代替机械倒计时。
    - **圆角与磨砂**：大量使用 `rounded-3xl` 和 `backdrop-blur`。
- **配色方案**：
    - *Fasting Mode (断食中)*：深海蓝渐变 (Deep Blue -> Purple)。
    - *Eating Mode (进食中)*：晨曦金渐变 (Soft Orange -> Warm Yellow)。

---

## 3. 功能模块详情 (Feature Specifications)

### 3.1 首页：弹性时钟 (Home Screen)

这是用户停留 90% 时间的页面。

### 3.1.1 UI 布局

- 中央：巨大的圆形进度条（带有呼吸动效）。
- 圆环内：显示当前状态（Fasting / Eating）+ 剩余时间/已进行时间。
- 圆环下方：主操作按钮（Start Fast / End Fast）。
- 底部：次级操作区：
    - “Edit Start Time”（修改开始时间）
    - “Backfill Session”（补录断食，入口可放在历史页或设置页，MVP 可先放设置页）

### 3.1.2 核心状态机（替代 IS_FASTING=true/false）

- `idle`：未开始
- `fasting`：断食进行中
- `paused`：暂停/中断（可选，MVP 可先不做 UI，但数据层预留）
- `completed`：断食完成（达成目标）
- `eating`：进食窗口

### 3.1.3 计时与恢复逻辑（MVP 必须可恢复）

- 页面展示的“已进行/剩余时间”**永远由时间戳计算**：
    - `elapsed = now - start_at`
    - `remaining = target_duration - elapsed`
- App 冷启动/杀后台重启后：
    - 从 `AsyncStorage` 读取 `start_at/end_at/target_duration/fasting_status/timezone`。
    - 用 `now` 重新计算状态与剩余时间（不依赖计时器是否持续运行）。
- 系统时间被改或跨时区：
    - 以记录的 `timezone` 做展示与纠错提示。
    - 发现 `now < start_at` 时进入异常处理：提示用户检查系统时间，并要求确认是否进入“补录”。

### 3.1.4 弹性调整（Elastic Logic）——明确边界

为了避免“篡改已发生历史”，将编辑分为两类：

**A. 微调 Adjust（用于纠错）**

- 入口："Edit Start Time"。
- 规则：仅允许在开始后 `<= 30 分钟` 内微调（或允许最近 24 小时内，但建议先保守）。
- 允许范围：前后 `<= 1 小时`。
- 行为：
    - 修改 `start_at` 后，`end_at`（若尚未结束）随之平移，以保持 `target_duration` 不变。
    - `source=manual_edit`。

**B. 补录 Backfill（用于补录历史）**

- 入口："Backfill Session"。
- 规则：用户手动填写 start/end，且必须满足：
    - `start_at < end_at <= now`
    - 记录不得与已有 session 重叠
- 行为：
    - 保存为独立 session
    - `source=backfill`
    - 显示“补录”标识

### 3.1.5 本地存储

- 每次状态改变（Start/End/Adjust/Backfill），立即写入 `AsyncStorage`。
- 存储内容至少包含：当前进行中的 session + 最近 N 条历史 session（按 MVP 容量决定）。

---

### 3.2 底部浮窗：AI 餐盘分析 (AI Camera - Pro Feature)

- **入口**：首页右下角的悬浮按钮 (FAB)，图标为相机。

### 3.2.1 交互流程

1. 点击相机图标。
2. **判断权益**：
    - Free 用户：弹出付费墙 (Paywall Modal)。
    - Pro 用户：进入相机/相册。
3. 选择/拍照。
4. 图片转 Base64 -> 发送至 OpenAI API。
5. **Loading 态**：显示“分析营养成分中...”的动画。
6. **结果弹窗**：展示 AI 返回的建议与必要免责声明。

### 3.2.2 Prompt 与输出格式（更可控）

- 系统提示词方向："你是一个营养师，请分析这张图片，只返回 JSON 格式。"

**JSON 输出（MVP 建议）**

- `cal_est`：热量估算（可为区间，如 450-650）
- `gi_level`：升糖指数（高/中/低）
- `one_liner`：一句话建议（20 字以内）
- `detected_items[]`：识别到的主要食物（最多 5 个，允许 unknown）
- `confidence`：低/中/高
- `assumptions`：关键假设（如“按一份标准餐估算”）
- `safety_note`：固定短句（如“仅供参考，不替代专业建议”）

### 3.2.3 风控联动（简化版）

- 若用户在健康信息中勾选高风险条件（如糖尿病用药、孕哺期等）：
    - AI 结果中必须额外提示“更谨慎的建议”与“请先咨询专业人士”。

---

### 3.3 设置与历史 (Settings & Profile)

### 3.3.1 断食计划选择（与风控一致）

- 16:8（新手推荐）
- 18:6（进阶）
- 20:4（高阶）

**产品决策：系统推荐为主，用户可在安全范围内选择**

- 若触发保守模式（见 6.1）：
    - 禁止选择过长断食窗口，或需要二次确认（MVP 可直接禁止更省事）。

### 3.3.2 通知开关

- “断食结束时通知我”（Toggle）。

**通知策略（MVP 必须可恢复）**

- 每次 `start_at/end_at/target_duration` 变化：
    - `cancelAllScheduledNotifications()`
    - 重新 schedule 对应的通知
- 若未获得通知权限：
    - 在首页/设置页给出明显提示“提醒未开启（需要通知权限）”，而不是静默失败。

### 3.3.3 历史记录

- Free：最近 7 次 session。
- Pro：完整历史 + 周/月趋势图表。

### 3.3.4 数据清除

- Reset Data 按钮（用于测试）。

---

## 3.4 生命体征和状态推导模块

### 3.4.1 输入字段补充（数据字典）

- 必填字段（本期）
- 身高：`height_cm`（整数，范围建议 80–250）
- 体重：`weight_kg`（1 位小数，范围建议 20–300）
- 年龄：`age_years`（整数，范围建议 6–120；若 <18 走青少年模式/限制断食方案）
- **IBW（理想体重，用户可修改）**：`ibw_kg`
    - 默认由系统计算，允许编辑
    - 编辑后标记：`ibw_user_edited=true`
- 强烈建议字段（可选，显著提升准确性）
- 性别：`sex`（male/female/other/unknown）
- 腰围：`waist_cm`（用于腹型肥胖/内脏脂肪风险）
- 活动水平：`activity_level`（久坐/轻度/中度/高强度）
- 静息心率（用户填）：`rhr_bpm`（用于心血管状态升级）
- 血压（用户填）：`sbp/dbp`（用于心血管状态升级）
- 既往病史与用药：`conditions[]`、`medications[]`（用于断食安全策略）

> 交互建议：这些字段作为“提升准确性”卡片引导填写，不阻断主流程。
> 

---

## 3) 推导/计算指标清单（本期可落地）

> 说明：所有“数值”由本地规则/公式计算；大模型只负责解释、建议与文案组织。
> 

### 3.1 体型与体重（全身）

- 指标：BMI、体重分层、目标体重区间（基于 BMI 正常范围）
- 展示用途：断食方案强度上限、饮食结构建议、阶段目标

### 3.2 能量代谢（代谢系统：肝脏/肌肉相关的能量利用）

- 指标：BMR（基础代谢，若无性别则用“中性估算”并标注误差）、TDEE（结合活动水平；无活动水平则默认“轻度”并标注）
- 展示用途：生成“进食日参考热量/蛋白目标”与断食窗口推荐

### 3.3 腹部脂肪（腹部/内脏脂肪风险，需腰围）

- 指标：腹型肥胖风险分层（基于腰围阈值按性别）
- 展示用途：强调“晚间进食”“精制碳水控制”“步行/力量训练”优先级

### 3.4 肌肉与功能风险（肌肉/骨骼）

- 指标：肌少症风险倾向（粗筛：年龄 + BMI 偏低/体重偏低；若有体脂率更佳）
- 展示用途：在断食建议中强制加入“蛋白质、抗阻训练、避免过长断食”策略

### 3.5 心血管风险倾向（心脏/血管）

- 指标：体重相关心血管风险倾向（由 BMI + 年龄分层生成“低/中/高”）
- 升级条件：若用户提供 `rhr_bpm` 或 `sbp/dbp`，输出“心血管状态综合提示”（仍非诊断）
- 展示用途：断食窗口选择、运动安排、夜间进食控制提示

### 3.6 骨健康支持度（骨骼）

- 指标：骨健康风险/支持度（年龄 + BMI 过低 + 运动/钙维D（若采集））
- 禁止：输出“骨密度数值（g/cm²）”或暗示“测得骨密度”
- 展示用途：提醒不要过度热量赤字、强调力量训练与营养补充

---

## 4) 页面展示补充（UI/信息架构）

### 4.1 生命体征展示区（建议改名：系统状态卡片）

- 卡片 1：**体型状态**（BMI + 分层 + 一句话解释）
- 卡片 2：**代谢与能量**（BMR/TDEE 估算 + “用于制定进食日目标”说明）
- 卡片 3：**心血管风险倾向**（低/中/高 + 关键影响因素：年龄/体重）
- 卡片 4：**肌肉保护优先级**（低/中/高 + 蛋白/抗阻提示）
- 卡片 5（可选）：**腹部脂肪风险**（需腰围）
- 卡片 6（可选）：**骨健康支持度**（替换“骨密度”字样）

> 展示规则：每张卡片必须包含“数据来源：基于输入估算/用户自填”标签。
> 

### 4.2 健康测评结果与建议（页面底部）

- 输出结构固定为三段：
    1. **你的现状画像**（引用 2–3 个最关键指标）
    2. **断食方案建议**（推荐窗口、频次、进食日策略）
    3. **风险提示与注意事项**（与用户画像强关联）

---

## 5) 大模型能力边界与提示词策略（实现约束）

### 5.1 输入给大模型的结构化参数（示例）

- `height_cm, weight_kg, age_years, bmi, bmr_est, tdee_est, risk_scores{cardio, muscle, visceral, bone}, user_goals, fasting_history(optional), conditions(optional), medications(optional)`

### 5.2 大模型输出格式（强约束，便于前端渲染）

- `summary_title`
- `cards[]`：每项包含 `name、level、reason(<=60字)、action(<=60字)、disclaimer_tag`
- `plan_recommendation`：断食窗口、频次、进食日要点（条目化）
- `safety_alerts[]`：触发原因 + 行动建议（例如“停止断食/补水/就医”）

### 5.3 文案红线（必须写进系统提示/审核规则）

- 禁止：诊断用语（“你患有/你有心脏病/骨质疏松”）
- 禁止：输出真实生命体征数值（除非用户提供）
- 必须：声明“估算/风险倾向，仅供健康管理参考”

---

## 6) 断食安全风控（规则优先于大模型）

### 6.1 方案限制/改为保守模式（示例）

- 年龄 <18：默认不推荐断食方案（只给健康饮食与作息建议）
- BMI 明显偏低：不推荐 16:8 及以上，优先“规律进食+营养强化”
- 有以下任一项（用户勾选/填写触发）：糖尿病用药、孕哺期、进食障碍史、严重肝肾疾病等
    - 动作：只显示“请先咨询医生/不提供断食计划”，并给一般性饮食建议

### 6.2 过程中的异常提示（后续可用于打卡）

- 用户记录“头晕、心悸、出冷汗”等：弹出“立即停止断食+补水与电解质+必要时就医”提示

---

## 7) 埋点与数据记录（用于迭代）

- 基本信息填写完成率（必填/可选字段分别统计）
- 各卡片曝光/点击（用户最关心的部位/系统）
- 大模型建议采纳率（开始某方案/坚持天数）
- 安全提示触发率与原因分布
- IBW 被用户编辑的比例与编辑幅度（用于评估默认算法是否合理）


AI 餐盘分析提示词工程 (Prompt Engineering for Flux App)

0. API 配置参数 (Configuration)

注意：这是当前项目专用的模型配置，请确保在 Cursor 或代码环境变量中正确设置。

模型名称 (Model Name): Doubao-Seed-1.8

API Key: aa75539a-ddc6-4442-97b5-8d2d8d4be7c4

接入建议：豆包模型的中文语义理解极强，因此 System Prompt 使用全中文设定效果最佳。

1. 系统设定 (System Prompt)

用途：设置在 API 调用的 system 角色字段中，定义 AI 的行为模式。

你是一位资深的“间歇性断食与代谢健康专家” (Flux AI)。你的核心任务是通过视觉识别用户的食物图片，分析其营养成分，并基于“血糖控制”和“断食节律”提供简短、科学且有行动导向的建议。

请遵循以下分析原则：
1. **识别精准**：准确识别盘中的主要食物成分。
2. **关注血糖**：特别关注碳水化合物的质量（精制 vs 粗粮）和升糖指数 (GI)。
3. **断食场景**：
   - 如果食物富含优质脂肪和蛋白质，标记为“适合开食”或“饱腹感强”。
   - 如果食物是高糖/精制碳水，标记为“血糖波动风险”，并建议餐后运动。
4. **输出格式**：必须严格返回纯 JSON 格式，不要包含 markdown 标记（如 ```json）。
5. **语言风格**：专业、温暖、简洁（像一位体贴的私人营养师）。


2. 用户指令模板 (User Prompt Template)

用途：发送给 API 的具体指令，包含图片和上下文变量。

输入变量：

{{IMAGE}}: 用户上传的图片 Base64 或 URL。

{{CURRENT_STATE}}: 用户当前状态 (例如: "准备开始断食" 或 "刚刚结束断食/准备开食")。

提示词内容：

[图片]
请分析这张食物图片。用户的当前状态是：{{CURRENT_STATE}}。

请严格按照以下 JSON 格式返回分析结果（不要输出任何其他废话）：

{
  "foodName": "食物名称 (10字以内)",
  "calories": 估算总热量 (整数，单位 kcal),
  "tags": ["标签1", "标签2", "标签3"], // 例如：高蛋白、低升糖、优质脂肪、碳水炸弹、高纤维
  "advice": "针对断食状态的建议 (30字以内，例如：这顿饭蛋白质丰富，非常适合作为断食后的第一餐，能平稳血糖。)",
  "nextStep": "一个具体的行动建议 (20字以内，例如：建议餐后散步15分钟以平抑血糖峰值。)"
}


3. 场景化 Few-Shot 示例 (给 AI 的参考范例)

为了提高准确率，可以在 Prompt 中加入一两个示例（如果是 Doubao/GPT-4o，直接加在 System Prompt 之后）。

示例 1：健康沙拉

输入：一张鸡胸肉牛油果沙拉图片。状态：准备开食。
期望输出：

{
  "foodName": "牛油果鸡胸肉沙拉",
  "calories": 420,
  "tags": ["高蛋白", "优质脂肪", "低升糖"],
  "advice": "完美的开食选择！优质脂肪和蛋白质能提供平稳的能量，不会引起胰岛素剧烈波动。",
  "nextStep": "细嚼慢咽，享受你的第一餐。"
}


示例 2：高碳水拉面

输入：一张豚骨拉面图片。状态：准备开始断食（封窗前最后一餐）。
期望输出：

{
  "foodName": "日式豚骨拉面",
  "calories": 750,
  "tags": ["高碳水", "高钠", "血糖波动风险"],
  "advice": "碳水含量较高，可能会导致血糖快速上升后回落，断食初期可能会感到饥饿。",
  "nextStep": "建议餐后站立或散步20分钟，帮助消耗多余糖分。"
}


4. 前端对接数据结构 (TypeScript Interface)

这是前端代码中用于接收上述 JSON 的数据结构定义。

interface FoodAnalysisResult {
  foodName: string;      // 例如 "牛油果烤鸡胸沙拉"
  calories: number;      // 例如 450
  tags: string[];        // 例如 ["高蛋白", "优质脂肪"]
  advice: string;        // 核心建议
  nextStep: string;      // 行动指南
}


5. 错误处理 (Fallback)

如果 AI 无法识别图片（例如图片模糊或不是食物），请指示 AI 返回以下特定 JSON：

{
  "error": true,
  "message": "看起来这不是食物，或者图片太模糊了。请再拍一张试试！"
}


这是一份整理好的**《断食生理阶段定义与文案规范》**，专门针对 **Flux (灵动断食)** 的产品调性进行了优化。

这份文档不仅包含了科学解释，还包含了**给用户看的UI文案**（更通俗、更有成就感），你可以直接复制粘贴到你的 PRD 文档的 **“核心算法与状态机”** 章节中。

---

# 🧬 Flux 产品需求文档附录：断食生理阶段定义

## 1. 阶段总览 (Overview)

断食不仅仅是“不吃东西”，而是一个通过时间轴触发的**激素与代谢变化过程**。Flux 的核心体验在于将这些看不见的体内变化，通过 UI (呼吸圆环) 可视化呈现出来。

### 阶段划分逻辑表

| 阶段 ID | 时间窗口 (小时) | 阶段名称 (Internal) | UI 显示文案 (User Facing) | 核心生理变化 (科学解释) | UI 视觉建议 |
| --- | --- | --- | --- | --- | --- |
| **Phase 1** | **0 - 4** | 消化期 (Anabolic) | **能量储存中** | 血糖上升，胰岛素分泌，身体正在处理刚摄入的食物。 | 暖色调 (晨曦黄) <br>

<br> 平静无波澜 |
| **Phase 2** | **4 - 12** | 分解代谢 (Catabolic) | **血糖平稳期** | 胰岛素下降，停止脂肪储存，开始消耗肝糖原。 | 过渡色 (浅绿/淡蓝) <br>

<br> 缓慢律动 |
| **Phase 3** | **12 - 18** | 燃脂期 (Fat Burning) | **🔥 脂肪燃烧** | 肝糖原耗尽，身体被迫燃烧脂肪供能，产生酮体。 | 核心色 (深海蓝/紫) <br>

<br> 呼吸感增强 |
| **Phase 4** | **18 - 24** | 酮症/自噬 (Ketosis) | **✨ 细胞净化** | 深度燃脂，自噬作用启动(Autophagy)，清理老化细胞。 | 激越色 (金色粒子特效) <br>

<br> 强烈的光晕 |
| **Phase 5** | **24 - 72** | 深度修复 (Deep Repair) | **生长激素激增** | 生长激素(HGH)大幅提升，免疫系统重建。 | 神秘色 (极光色) <br>

<br> 缓慢而深沉 |

---

## 2. 断食阶段的详细文案与解释 (Detailed Descriptions)

以下内容用于 APP 内的“阶段详情弹窗”或“知识卡片”。

### Phase 1: 能量储存 (0 - 4 小时)

* **用户视角的解释**：
> “你刚刚享用完一顿美餐，身体正在消化食物并吸收营养。此时胰岛素水平升高，身体处于‘合成模式’。”



### Phase 2: 血糖平稳 (4 - 12 小时)

* **用户视角的解释**：
> “食物已经消化完毕。胰岛素水平开始下降，身体不再储存脂肪，转而消耗之前储存的糖原。这是通往燃脂模式的必经之路。”


* **痛点应对**：
> 用户可能会在这个阶段（约第 6-8 小时）感到饥饿。
> **APP 提示**：“如果感到饥饿，这是血糖下降的正常信号。喝一杯水或黑咖啡，这种感觉通常在 20 分钟内消失。”



### Phase 3: 脂肪燃烧 (12 - 18 小时) —— *这是 16:8 断食的核心目标区*

* **用户视角的解释**：
> “恭喜！你的身体刚刚切换了‘燃料来源’。肝糖原已耗尽，身体开始直接分解脂肪来获取能量。这是减脂效率最高的黄金窗口。”


* **UI 激励**：
> 当用户跨过 12 小时门槛时，APP 应发送震动反馈或显示粒子特效：“燃脂模式已启动！”



### Phase 4: 细胞净化 / 自噬 (18 - 24 小时)

* **用户视角的解释**：
> “你进入了深度修复状态。这就好比身体开启了‘大扫除’模式（细胞自噬），清理受损的细胞部件，回收蛋白质。这是抗衰老和焕发活力的关键阶段。”


* **科学背书**：
> 引用 2016 年诺贝尔生理学奖关于“细胞自噬”的研究，增加权威感。



---

## 3. UI 状态机逻辑 (State Machine Logic)

为了方便开发（Cursor），我们可以这样定义状态机：

```typescript
// 断食阶段枚举
enum FastingStage {
  ANABOLIC = 'ANABOLIC',       // 0-4h
  CATABOLIC = 'CATABOLIC',     // 4-12h
  FAT_BURNING = 'FAT_BURNING', // 12-18h
  KETOSIS = 'KETOSIS',         // 18-24h
  DEEP_REPAIR = 'DEEP_REPAIR'  // 24h+
}

// 获取当前阶段的 Helper 函数
function getFastingStage(elapsedHours: number): FastingStage {
  if (elapsedHours < 4) return FastingStage.ANABOLIC;
  if (elapsedHours < 12) return FastingStage.CATABOLIC;
  if (elapsedHours < 18) return FastingStage.FAT_BURNING;
  if (elapsedHours < 24) return FastingStage.KETOSIS;
  return FastingStage.DEEP_REPAIR;
}

// 获取阶段对应的 UI 配置
const STAGE_CONFIG = {
  [FastingStage.ANABOLIC]: {
    label: "能量储存",
    description: "身体正在消化食物，胰岛素上升。",
    color: "from-orange-100 to-amber-200", // 暖色
    icon: "Sun"
  },
  [FastingStage.FAT_BURNING]: {
    label: "脂肪燃烧",
    description: "糖原耗尽，开始直接燃烧脂肪。",
    color: "from-indigo-500 to-purple-600", // 深色燃脂
    icon: "Flame"
  },
  // ... 其他阶段
}

```

---

### 💡 建议

在 **MVP 版本**中，重点做好 **Phase 3 (12-18小时)** 的视觉反馈。因为绝大多数用户采用的是 16:8 断食法，**第 16 个小时**是他们坚持的终点，也是获得成就感的巅峰时刻。务必在第 16 小时倒计时结束时，给予最强烈的视觉奖励（如满屏烟花或金币音效）。