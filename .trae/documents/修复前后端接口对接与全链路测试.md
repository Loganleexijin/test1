## 现状诊断（已定位到的根因）
- **后端接口响应契约与前端请求封装不一致**：前端 [api.ts](file:///Users/lee/Documents/自己的项目/断食APP/lovable-ui/three-meal-track/src/lib/api.ts) 强制要求 `{ success:true, data:... }`，但后端 AI 路由 [ai.ts](file:///Users/lee/Documents/自己的项目/断食APP/api/routes/ai.ts) 直接 `res.json(result)`，错误也用 `{ error:true, message }`；一旦前端真正接入 AI，会被前端判定为失败。
- **鉴权链路断层**：后端 `/api/auth/register|login|logout` 返回 501（未实现）[auth.ts](file:///Users/lee/Documents/自己的项目/断食APP/api/routes/auth.ts)，前端仅有 `authToken` 字段但未设置/未注入请求 [userStore.ts](file:///Users/lee/Documents/自己的项目/断食APP/lovable-ui/three-meal-track/src/stores/userStore.ts)。
- **“数据库连接”不满足生产部署**：后端当前用本地 JSON 文件读写 [simple-db.ts](file:///Users/lee/Documents/自己的项目/断食APP/api/utils/simple-db.ts)，在 Vercel serverless 环境会出现写入不可持久/多实例不一致等问题。
- **接口文档承诺与实现缺口**：需求文档 [README1.0.md](file:///Users/lee/Documents/自己的项目/断食APP/Project%20Plan/README1.0.md) 明确提到 mealRecords/AI 流程，但当前前端主页餐食与 AI 仍是 mock（例如 [Index.tsx](file:///Users/lee/Documents/自己的项目/断食APP/lovable-ui/three-meal-track/src/pages/Index.tsx) 里的 setTimeout 模拟）。
- **存在测试交互入口 UI**：主页包含“测试入口按钮组”（需删除）[Index.tsx](file:///Users/lee/Documents/自己的项目/断食APP/lovable-ui/three-meal-track/src/pages/Index.tsx#L178-L207)。

## 修复目标（以可上线为准）
- 前端请求层稳定：统一 baseURL/错误处理/超时/鉴权注入；所有接口返回可被前端可靠解析。
- 后端接口完整：注册登录、用户资料、断食记录、餐食记录、AI 分析、文件上传/下载的核心链路全打通。
- 数据持久化可用：替换/迁移文件型 DB 为可部署的持久化方案（优先 Supabase，仓库已有 schema）。
- 删除测试交互组件模块：移除主页调试按钮/占位测试文件与无效 demo 路由。
- 全链路测试 + 文档更新：关键用户场景覆盖，接口变更与部署注意事项可追溯。

## 方案选型（默认采用）
- **默认采用 Supabase 作为 Auth + Postgres 持久化**：仓库已提供 [supabase_schema.sql](file:///Users/lee/Documents/自己的项目/断食APP/supabase_schema.sql) 与 `.env.example` 中的 Supabase 配置项。
- **后端作为 BFF（Backend for Frontend）**：前端只调用 `/api/*`；后端负责鉴权校验、数据读写、AI 密钥保护与上传处理。

## 实施步骤（按阻塞优先级）
### 1) 统一接口契约与错误模型
- 后端：为所有路由（包括 AI）统一返回形态：`{ success:boolean, data?:T, message?:string, errorCode?:string }`。
- 前端：增强 [api.ts](file:///Users/lee/Documents/自己的项目/断食APP/lovable-ui/three-meal-track/src/lib/api.ts) 兼容 `message`/`error` 字段，并支持无 `data` 的成功返回（例如 `/fasting/cancel` 当前只返 message [fasting.ts](file:///Users/lee/Documents/自己的项目/断食APP/api/routes/fasting.ts#L108-L119)）。
- 产出：一份“响应规范”写入 docs，作为后续接口的验收标准。

### 2) 修复并补齐鉴权机制（注册/登录/会话）
- 新增后端 auth 中间件：读取 `Authorization: Bearer <token>`，校验 token 并注入 `req.user`。
- 实现 `/api/auth/register`、`/api/auth/login`、`/api/auth/logout`、`/api/auth/me`：
  - register/login 使用 Supabase Auth（password/或 OAuth 由前端发起后再换 token）。
  - me 用于前端启动时恢复登录态。
- 前端：
  - 在 `userStore` 增加登录态管理（保存 token、刷新用户资料）。
  - 在 `api.ts` 自动注入 Authorization 头，并对 401 做统一处理（清理状态、提示重新登录）。

### 3) 替换文件型 DB 为 Supabase（断食 + 餐食 + 用户资料）
- 后端新增 Supabase 数据访问层：把当前 `simple-db.ts` 的读写替换为对 `user_profiles / fasting_sessions / meal_records` 的 CRUD。
- 断食接口：保留现有路径（`/api/fasting/current|start|end|cancel|history|plan`），但改为按 `user_id` 隔离。
- 新增餐食接口（与文档对齐）：
  - `GET /api/meals/today`、`GET /api/meals?date=...`、`POST /api/meals`、`PATCH /api/meals/:id`、`DELETE /api/meals/:id`。
- 迁移策略：提供一次性脚本或后台管理端点（仅开发环境）把 `api/data/db.json` 迁入 Supabase，避免丢数据。

### 4) 打通 AI 餐盘分析与日总结链路
- 后端：
  - 保持 `/api/ai/analyze`、`/api/ai/analyze-day`，但改为统一响应契约；并增加输入校验、体积限制与更可读的错误码。
- 前端：
  - 把主页 mock 的餐食与 AI（setTimeout）替换为真实调用：拍照/相册选择 → 上传 → AI 分析 → 保存 meal_record → 刷新时间轴与 AISummary。

### 5) 文件上传/下载（图片）
- 后端新增上传端点：`POST /api/files/upload`（multipart/form-data 或 base64）
  - 上传到 Supabase Storage（返回可访问的 `image_url`），并在 `meal_records.image_url` 保存。
- 下载：提供 `GET /api/files/:id`（或直接使用 storage 公共 URL；如需鉴权则用签名 URL）。

### 6) 删除测试交互组件模块与无效测试/演示代码
- 前端：删除主页“测试入口按钮组”UI [Index.tsx](file:///Users/lee/Documents/自己的项目/断食APP/lovable-ui/three-meal-track/src/pages/Index.tsx#L178-L207)。
- 清理占位测试：`src/test/example.test.ts` 等（如不保留单测则同步移除 vitest 配置与脚本；如保留则改为真实 API/状态测试）。
- 后端：处理 `/api/auth/*` 里的 501 demo（改为真实实现或删除无用路由）。

### 7) 全链路功能测试与回归
- 后端集成测试：用 supertest/vitest 覆盖注册登录、断食 start/end/history、餐食 CRUD、AI analyze（可用 mock）、上传接口。
- 前端手动回归清单：
  - 未登录 → 登录/注册 → 恢复会话
  - 开始断食 → 结束/取消 → 历史展示
  - 拍照识别 → 生成餐食记录 → 今日总结
  - 错误场景：401、AI 超时、上传过大、无网络。

### 8) 文档更新与部署注意事项
- 更新 [README1.0.md](file:///Users/lee/Documents/自己的项目/断食APP/Project%20Plan/README1.0.md) 或新增 `docs/api-contract.md`：
  - 列出所有 `/api/*` 路径、请求/响应示例、错误码。
  - 明确环境变量（Supabase/AI key）、Vercel 部署注意事项（serverless 持久化问题已解决）。

## 验收标准（完成即算“对接正常”）
- 前端不再依赖 mock：主页断食状态/历史、餐食时间轴、AI 总结均来源真实 API。
- 任意接口失败时，前端能展示明确错误信息（非“Request failed: 500”泛化）。
- 生产环境不使用本地文件型 DB；同一用户数据跨刷新/跨实例保持一致。
- 测试交互入口已移除，demo/占位测试已清理或替换为真实测试。
