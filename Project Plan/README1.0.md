# 断食APP（Flux）需求文档（基于现有代码梳理）

## 1. 项目概述
本项目是一个以断食计时 + 饮食记录 + AI 餐盘分析为核心的移动端风格 Web App（前后端同仓）。前端使用 React + Vite + Tailwind，后端使用 Express 提供 API，并集成豆包（Doubao）视觉模型做食物识别与营养建议。产品名/品牌在 UI 中展示为“Flux”。

## 2. 目标用户与使用场景
目标用户是进行间歇性断食、希望记录断食进度和饮食情况的人群。核心场景包括：
- 开始断食、查看计时与阶段提示。
- 结束断食或补录历史断食。
- 通过拍照/上传图片记录餐食，并获得 AI 分析。
- 查看当日餐食时间轴与综合分析。
- 查看断食历史与数据概览。
- 个人资料、徽章与隐私设置管理。

## 3. 关键术语
- 断食计划：如 12:12、16:8、18:6、20:4、23:1。
- 断食阶段：能量储存、血糖平稳、燃脂、细胞自噬、深度修复（根据已过去时间计算）。
- 餐食记录：早餐/午餐/晚餐/加餐四类。
- AI 分析：对餐食图片生成热量、宏量营养素、标签与建议。
- Pro：订阅用户，解锁 AI 分析与完整历史等功能。

## 4. 功能需求

### 4.1 断食计时与计划
- 允许用户开始断食，记录开始时间与目标时长（小时）。
- 在断食中实时显示：
  - 剩余时间与进度百分比。
  - 当前阶段说明与下一阶段预计到达时间。
- 支持结束断食：
  - 如果断食时长小于 30 分钟，弹出提示允许“不记录/确认记录”。
- 支持取消断食（清除当前未完成记录）。
- 支持切换断食计划（12:12、16:8、18:6、20:4、23:1），并在断食中更新目标时长。
- 支持开始时间微调：
  - 只能在断食开始后 30 分钟内进入编辑。
  - 调整范围前后 1 小时内。
- 断食阶段提示：
  - 根据已过去小时数判断阶段。
  - 达到 12 小时触发“燃脂提示”与轻震动反馈（浏览器支持时）。

### 4.2 断食补录
- 允许用户补录历史断食记录：
  - 手动填写开始时间与结束时间。
  - 验证：结束时间必须晚于开始时间，且不能超过当前时间。
  - 记录来源标记为“补录”。

### 4.3 断食历史记录
- 显示断食历史列表：
  - 展示日期、持续时长、目标时长、来源标签（如补录）。
- 免费用户限制：仅显示最近 7 条记录。
- Pro 用户增强：
  - 统计概览：总记录数、已完成数、平均时长、完成率。

### 4.4 餐食记录与时间轴
- 记录餐食流程：
  - 选择餐次（早餐/午餐/晚餐/加餐）。
  - 拍照或从相册上传。
  - 图片压缩处理（客户端）。
  - 预览确认后进入 AI 分析。
- 当日时间轴：
  - 按餐次分段展示今日餐食。
  - 显示建议用餐时间区间。
  - 展示分析状态（分析中/失败/完成）。
- 餐食历史：
  - 按日期分组展示。
  - 支持按餐次过滤。
  - 展示图片、热量、标签与时间。

### 4.5 AI 餐盘分析
- 后端提供分析接口：
  - `/api/ai/analyze`：对单张图片进行分析。
  - `/api/ai/analyze-day`：根据当日餐食列表生成综合报告（总热量、评分与建议）。
- AI 返回内容规范：
  - JSON 格式，包含食物名、热量、宏量营养素、标签、建议与行动指引。
- 错误处理：
  - 无图片/模糊图片返回友好提示。
  - 超时与服务不可用返回错误信息。

### 4.6 当日综合饮食分析
- 自动汇总当日餐食记录：
  - 统计总热量、记录数、异常记录数。
- 显示状态：
  - 无记录时显示空状态。
  - 有分析中时显示加载状态。
  - 有错误且无完成记录时显示失败状态。
- 成功时展示：
  - 今日总热量与已完成记录数。
  - 简短饮食建议文本。

### 4.7 订阅与付费墙
- 免费用户限制：
  - AI 拍照识别入口被付费墙拦截（需升级）。
  - 历史记录仅展示最近 7 条。
  - 试用次数限制：当 `remainingFreeAnalyses <= 0` 时禁止分析。
- Pro 订阅选项：
  - 月卡 / 年卡 / 终身买断。
- 订阅切换仅修改本地状态（当前代码未接入真实支付）。

### 4.8 个人资料与账号
- 用户资料展示：昵称、头像、同步状态。
- 支持编辑：
  - 昵称修改。
  - 头像上传（本地 DataURL）。
- Google 登录：
  - 使用 Supabase OAuth 登录并同步基础资料。
- 隐私政策弹窗。
- 清空数据操作（清除断食记录与部分本地状态）。
- 联系方式展示（姓名/邮箱/微信）。

### 4.9 徽章系统
- 根据断食与 AI 使用情况生成徽章：
  - 首次断食
  - 燃脂大师
  - 自噬专家
  - 七日连胜
  - 省钱小能手
  - AI 探索者
- 徽章墙支持横向滑动，且可查看“全部徽章”。

## 5. 数据与状态

### 5.1 前端状态（Zustand）
- 断食状态：当前 session、历史 session、断食计划。
- 餐食记录：mealRecords + AI 分析结果。
- 用户资料：昵称、头像、订阅状态、AI 试用次数等。
- 徽章统计：由历史记录与餐食行为计算。
- 本地持久化：只持久化计划、认证 token、用户资料、徽章状态等，不持久化全部记录。

### 5.2 后端存储（简单 JSON DB）
- `api/data/db.json` 保存：
  - sessions（断食记录）
  - userSettings.plan
  - mealRecords（当前仅结构定义，功能尚未完整接入）

## 6. 关键接口
- 统一响应格式：`{ success, data, message? }`；失败：`{ success:false, message, errorCode? }`（详见 [docs/api-contract.md](file:///Users/lee/Documents/自己的项目/断食APP/docs/api-contract.md)）。
- `GET /api/fasting/current` 获取当前断食记录。
- `POST /api/fasting/start` 开始断食。
- `POST /api/fasting/end` 结束断食。
- `POST /api/fasting/cancel` 取消断食。
- `GET /api/fasting/history` 获取历史记录。
- `GET /api/fasting/plan` / `POST /api/fasting/plan` 读取/设置断食计划。
- `GET /api/meals/today` / `GET /api/meals?from=&to=` 获取餐食记录。
- `POST /api/meals` / `PATCH /api/meals/:id` / `DELETE /api/meals/:id` 餐食增删改查。
- `POST /api/files/upload` 上传图片（dataUrl）并返回 URL；`GET /api/files/signed-url` 生成签名链接。
- `POST /api/ai/analyze` AI 图片分析。
- `POST /api/ai/analyze-day` AI 当日综合分析。
- `POST /api/auth/register` / `POST /api/auth/login` / `POST /api/auth/logout` / `GET /api/auth/me` 账号与会话接口。

## 7. 非功能性要求
- 性能：
  - AI 请求超时控制（25s）。
  - 图片压缩后再上传以降低耗时。
- 安全与隐私：
  - 需要提示用户隐私政策。
  - AI API 密钥通过环境变量注入。
- 兼容性：
  - 面向移动端的 UI 设计（max width 约 375-430）。
  - 支持深色模式切换。
- 可用性：
  - 关键流程具备空状态与错误提示。
  - 重要操作带确认提示（如清空数据、短时断食结束）。

## 8. 已知限制与待完善点
- 餐食分析流程目前只在前端模拟状态更新，`analyzeMeal` 尚未真正调用后端并回写结果。
- 断食历史与餐食记录未完全与后端同步，部分数据仅保存在本地。
- 订阅与支付仅为 UI 与状态切换，未接入支付渠道。
- AI 试用次数未在代码中自动递减，需要后续补齐。

## 9. 交互与页面结构
- `/` 首页：断食计时 + AI 综合分析 + 今日餐食时间轴。
- `/history` 断食历史。
- `/meals` 餐食记录历史。
- `/settings` 个人中心与设置。
- 底部导航：首页 / 相机记录 / 我的。

## 10. 成功指标（可选）
- 日活用户的断食开启次数。
- 断食完成率与平均时长。
- 餐食记录率与 AI 分析完成率。
- Pro 转化率与试用转化率。
